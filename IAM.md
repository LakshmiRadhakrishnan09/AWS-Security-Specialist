
## IAM

### Identity
User or system that need access to resources in an AWS account.

* Identity based Policy
* Resource based Policy
* IAM Roles: temporary credentials

U can attch a policy to user, group, resource, role

Identity based Policy
* Attached to a identity
* What **actions** this user is allowed/denied on a **resource**

Resource based Policy
* attched to a resource
* What actions is allowed/denied for a **resource** for a **principal**(iam of the requestor)

* **IAM groups** are not supported as principals in any policy
* Principals : Not required in identity based policy. Needed for resource based policies and IAM role trust policy.
* Principal : Can be an arn of iam user or a service . Or a feratated user(company.com). Or Assumed role session(in another account, sts). 
* Privide account number -- means root user
* Anonymous user -- *

In general Identity policies are recommeneded than resource based policies. Resource based polcies support cross account access.

ARN:
* need region and accoun-id as part of most resouces
* for global resources like iam, s3 skip region
* for s3,skip region and account-id, since s3 is globally unique

* NotAction
* NotResource
* NotPrincipal
* Condition
  * NotIpAddress 
  * StringNotEquals
  * aws:CurrentTime
  * aws:RequestedRegion: region action need to be performed
  * aws:PrincipalTag : tag based access
  * aws:SecureTransport
  * aws:sourceIP
  * aws:sourceVpc
  * aws:sourceVpce
  * ec2:ResourceTag

**Attribute based Access Control** : Tag based. In RBAC(Role based) model , when new resources are added, policy need to be updated.In ABAC, require fewer polcies and scale nicely(eg: cost center matches)

**By default all requests are denied**
**Should be allowed atleast once**
**Explicit Deny overrides explicit allow**
**Permission Boundary, SCM policy, Session polciy may override allow with a deny**

Important: If any one of these policy types [identity-based policies, resource-based policies, permissions boundaries, Organizations SCPs, or session policies] explicitly denies access for an operation, then the request is denied.

### IAM role

Scanario: EC2 instance accessing S3. 

Attach role to Ec2 instance. Instance use ec2 meta data service to get temporary credentials.No need to maintain long term credentials.

STS: Service responsible for generating temporary credentials.

Role
* Attach access policy to Role. What can this role do
* Trust policy: who can use this role

### Cross account access
* Resource based policy
* IAM roles assume role

What is the effect of specifying a root user or account as the principal in a resource-based policy? Who gains access?
Root will get access. Root can delegate to other users or roles.

There are scenarios when you need to give access to your resources for a third-party account: **IAM Role External ID**. When enabled, in order to assume the role, the third party needs to have the Role ARN, and they also need to provide the External ID value. The assume role will succeed only if the third-party account is a trusted entity and the external ID values match.The use of the external ID prevents the "confused-deputy" problem when the third-party provides similar service to other customers. 

### Federation
Using external identities for accessing AWS. Corporate identity or Internet Identity.

Corporate Identity: AWS Supports SAML 2.0, Active Directory
Corporate Identity Provider --- Establish Trust --- AWS Identity Federation \
Roles in AWS Account. \
User signs with corporate credentials using federation web interface\
Federation machanism maps user to IAM role. User assume role. \

AWS Organisation enables SSO

Internet Identity: Google, facebook identity to access AWS. \
Cognito service map external identity to Cognito Identity. \
External Identity trusted with Cognito. \
Applications in AWS can use Cognio Identity. \
Cognito supports SAML 2.0, OAuth , OpenID Connect. \

AWS Directory Services
* AWS Directory Service for Microsoft AD : AD in AWS. Ideal for lift and shift.
   * Standard
   * Enterprise
   * Hybrid setup: AD in AWS trust On-premise AD. So users in enterprise is truested by cloud and users can access AWS resources. One way or two way trust
   * Better option for most customers
* AD Connector: Proxy Service. Forward all requests from AD connector in AWS to onpremise . Users are in on-premise AD. Users can access cloud. Not compatible for RDS-MySQL.
* Simple AD: Standalone directory. No trust establishment.Not compatible for RDS-MySQL.

Common Scenarios for Temporary Credentials
· Identity Federation – Enterprise and Web identity federation

· Roles for cross-account access

· Roles for EC2 instances to access AWS resources

· Roles for other services to access your AWS resources or perform actions on your behalf


STS is a global service with a single endpoint https://sts.amazonaws.com. However, you can also make STS API calls to regional endpoints. The credentials generated by regional endpoints work globally

Revoking access to Temporary Credentials: You cannot delete temporary credentials. Revoke permission of creator , the identity that was used when calling STS APIs to generate temporary credentials. Revoke by user, or role ot by time. 
You can attach a deny all policy that applies only if the temporary credential was issued before a specific time (using aws:TokenIssueTime variable).

#### Permissions Boundary

A permissions boundary set the maximum permissions that an identity-based policy can grant to an IAM entity. Apply only to identity-based policy. **Does not apply to the resource-based policy**.

### Shared responsibility

EC2
* U are responsible for updating and patching OS, Firewalls, Security Group, Network ACL
Managed Product- S3
* AWS responsible for Hardware, Software, Scalability


You can use one of these methods to generate temporary credentials

· AssumeRole

· AssumeRoleWithWebIdentity

· AssumeRoleWithSAML

· GetFederationToken :used for custom identity broker(on-premise).

· GetSessionToken

For an on-premises application that needs to connect to AWS, we need to store the Access Key credentials in the on-premises system. What is the best way to protect these credentials? We want to ensure only authorized applications and personnel access this key. \
Answer: Option 1: Use a vault. Option 2: Enable identity federation between on-premises and AWS (using SAML 2.0 or Microsoft Active Directory and so forth). Configuring SSO with AWS CLI



Enable Private DNS Name option: the standard AWS KMS DNS hostname (https://kms.<region>.amazonaws.com) will resolve to your VPC endpoint.
 
Note: For a resource based policy with IP restriction, we can use only Public IPs. 
 
SAML Provider Integration
 
* Use SAML provider with Amazon Cognito
* Configure SAML provider in Cognito to Map attributes to Cognito user pool attributes
* Establish Trust between SAML provider and Cognito 
* Configure API Gateway to use Cognito
 
For Lambda to log to CloudWatch \
Allow logs:CreateLogGroup(When function is first executed), logs:CreateLogStream( For each lambda execution), logs:PutLogEvents
 

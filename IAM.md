
## IAM

### Identity
User or system that need access to resources in an AWS account.

* Identity based Policy
* Resource based Policy
* IAM Roles: temporary credentials

U can attch a policy to user, group, resource, role

Identity based Policy
* Attached to a identity
* What **actions** this user is allowed/denied on a **resource**

Resource based Policy
* attched to a resource
* What actions is allowed/denied for a **resource** for a **principal**(iam of the requestor)

* **IAM groups** are not supported as principals in any policy
* Principals : Not required in identity based policy. Needed for resource based policies and IAM role trust policy.
* Principal : Can be an arn of iam user or a service . Or a feratated user(company.com). Or Assumed role session(in another account, sts). 
* Privide account number -- means root user
* Anonymous user -- *

In general Identity policies are recommeneded than resource based policies. Resource based polcies support cross account access.

ARN:
* need region and accoun-id as part of most resouces
* for global resources like iam, s3 skip region
* for s3,skip region and account-id, since s3 is globally unique

* NotAction
* NotResource
* NotPrincipal
* Condition
  * NotIpAddress 
  * StringNotEquals
  * aws:CurrentTime
  * aws:RequestedRegion: region action need to be performed
  * aws:PrincipalTag : tag based access
  * aws:SecureTransport
  * aws:sourceIP
  * aws:sourceVpc
  * aws:sourceVpce
  * ec2:ResourceTag

**Attribute based Access Control** : Tag based. In RBAC(Role based) model , when new resources are added, policy need to be updated.In ABAC, require fewer polcies and scale nicely(eg: cost center matches)

**By default all requests are denied** \
**Should be allowed atleast once** \
**Explicit Deny overrides explicit allow** \
**Permission Boundary, SCM policy, Session polciy may override allow with a deny**

Important: If any one of these policy types [identity-based policies, resource-based policies, permissions boundaries, Organizations SCPs, or session policies] explicitly denies access for an operation, then the request is denied.

### IAM role

Scanario: EC2 instance accessing S3. 

Attach role to Ec2 instance. Instance use ec2 meta data service to get temporary credentials.No need to maintain long term credentials.

STS: Service responsible for generating temporary credentials.

Role
* Attach access policy to Role. What can this role do
* Trust policy: who can use this role

### Cross account access
* Resource based policy
* IAM roles assume role

What is the effect of specifying a root user or account as the principal in a resource-based policy? Who gains access?
Root will get access. Root can delegate to other users or roles.

There are scenarios when you need to give access to your resources for a third-party account: **IAM Role External ID**. When enabled, in order to assume the role, the third party needs to have the Role ARN, and they also need to provide the External ID value. The assume role will succeed only if the third-party account is a trusted entity and the external ID values match.The use of the external ID prevents the "confused-deputy" problem when the third-party provides similar service to other customers. 

### Federation
Using external identities for accessing AWS. Corporate identity or Internet Identity.

Corporate Identity: AWS Supports SAML 2.0, Active Directory
Corporate Identity Provider --- Establish Trust --- AWS Identity Federation \
Roles in AWS Account. \
User signs with corporate credentials using federation web interface\
Federation machanism maps user to IAM role. User assume role. \

AWS Organisation enables SSO

Internet Identity: Google, facebook identity to access AWS. \
Cognito service map external identity to Cognito Identity. \
External Identity trusted with Cognito. \
Applications in AWS can use Cognio Identity. \
Cognito supports SAML 2.0, OAuth , OpenID Connect. \

AWS Directory Services
* AWS Directory Service for Microsoft AD : AD in AWS. Ideal for lift and shift.
   * Standard
   * Enterprise
   * Hybrid setup: AD in AWS trust On-premise AD. So users in enterprise is truested by cloud and users can access AWS resources. One way or two way trust
   * Better option for most customers
* AD Connector: Proxy Service. Forward all requests from AD connector in AWS to onpremise . Users are in on-premise AD. Users can access cloud. Not compatible for RDS-MySQL.
* Simple AD: Standalone directory. No trust establishment.Not compatible for RDS-MySQL.

Common Scenarios for Temporary Credentials
· Identity Federation – Enterprise and Web identity federation

· Roles for cross-account access

· Roles for EC2 instances to access AWS resources

· Roles for other services to access your AWS resources or perform actions on your behalf


STS is a global service with a single endpoint https://sts.amazonaws.com. However, you can also make STS API calls to regional endpoints. The credentials generated by regional endpoints work globally

### Configure AWS to federate authentication using a third-party SAML 2.0 compliant identity providers(ADFS)

ADFS: Identity Broker \
AD: Identity Provider

A SAML identify provider can be configured using the AWS console :
- Access the “Identity Providers” section of the AWS IAM console
- Select SAML for the provider type. Select a provider name of your choosing (this will become the logical name used in the identity provider ARN. Eg: idp1). Lastly, download the FederationMetadata.xml file from your ADFS server to your client system file (https://yourADFSserverFQDN/FederationMetadata/2007-06/FederationMetadata.xml). Click “Choose File” and upload it to AWS.
- create the roles in AWS that federated users can assume via SAML 2.0.
- SAML assertions to the AWS environment and the respective IAM role access will be managed through regular expression (regex) matching between your on-premises AD group name to an AWS IAM role.
- ADFS federation occurs with the participation of two parties; the identity or claims provider (in this case the owner of the identity repository – Active Directory) and the relying party, which is another application that wishes to outsource authentication to the identity provider; in this case Amazon Secure Token Service (STS). The relying party is a federation partner that is represented by a claims provider trust in the federation service.

<img width="755" alt="Screenshot 2022-10-31 at 4 30 12 PM" src="https://user-images.githubusercontent.com/33679023/198993264-01804f76-b9a2-4230-a826-26c72f178d89.png">

- Corporate user accesses the corporate Active Directory Federation Services portal sign-in page and provides Active Directory authentication credentials.
- AD FS authenticates the user against Active Directory.
- Active Directory returns the user’s information, including AD group membership information.
- AD FS dynamically builds ARNs by using Active Directory group memberships for the IAM roles and user attributes for the AWS account IDs, and sends a **signed assertion to the users browser with a redirect to post the assertion to AWS STS.**
- Temporary credentials are returned using STS AssumeRoleWithSAML.
- The user is authenticated and provided access to the AWS management console.

https://aws.amazon.com/blogs/security/aws-federated-authentication-with-active-directory-federation-services-ad-fs/

#### Permissions Boundary

A permissions boundary set the maximum permissions that an identity-based policy can grant to an IAM entity. Apply only to identity-based policy. **Does not apply to the resource-based policy**.

### Shared responsibility

EC2
* U are responsible for updating and patching OS, Firewalls, Security Group, Network ACL. \
S3(Managed Product)
* AWS responsible for Hardware, Software, Scalability


You can use one of these methods to generate temporary credentials

· AssumeRole

· AssumeRoleWithWebIdentity

· AssumeRoleWithSAML

· GetFederationToken :used for custom identity broker(on-premise).

· GetSessionToken

For an on-premises application that needs to connect to AWS, we need to store the Access Key credentials in the on-premises system. What is the best way to protect these credentials? We want to ensure only authorized applications and personnel access this key. \
Answer: Option 1: Use a vault. Option 2: Enable identity federation between on-premises and AWS (using SAML 2.0 or Microsoft Active Directory and so forth). Configuring SSO with AWS CLI



Enable Private DNS Name option: the standard AWS KMS DNS hostname (https://kms.<region>.amazonaws.com) will resolve to your VPC endpoint.
 
Note: For a resource based policy with IP restriction, we can use only Public IPs. 
 
SAML Provider Integration
 
* Use SAML provider with Amazon Cognito
* Configure SAML provider in Cognito to Map attributes to Cognito user pool attributes
* Establish Trust between SAML provider and Cognito 
* Configure API Gateway to use Cognito
 
For Lambda to log to CloudWatch \
Allow logs:CreateLogGroup(When function is first executed), logs:CreateLogStream( For each lambda execution), logs:PutLogEvents
 
### External ID
Scenario: Example Corp want to access ur account / 
 
create an IAM role that gives Example Corp access to your resources. Like any IAM role, the role has two policies, a permission policy and a trust policy. The role's trust policy specifies who can assume the role. In our sample scenario, the policy specifies the AWS account number of Example Corp as the Principal. This allows identities from that account to assume the role. In addition, you add a **Condition element to the trust policy**. This Condition tests the ExternalId context key to ensure that it matches the unique customer ID from Example Corp. 
 
For example: 
 
     "Principal": {"AWS": "Example Corp's AWS Account ID"},
    "Condition": {"StringEquals": {"sts:ExternalId": "Unique ID Assigned by Example Corp"}}
 
 
 ###  A IAM role assuming another role
 
 #### In same account
 
 Let’s say we have two roles, Role_A and Role_B. If we want to allow Role_A to assume Role_B, we need to modify the **trust relationship of Role_B** with the following:
```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::111111111111:role/Role_A"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
``
 
 Principal elemnt : used i resource policies and in trust policies. you’ll get errors if you try to use the Principal element in an IAM Role policy
 
 #### In another account
 
 - Role_B needs to have its trust relationship modified to allow Role_A to assume it.(same as above)
 - The difference here is that Role_A will need an additional policy with sts:AssumeRole permissions.
 
 And Role_A needs the following attached as a policy:
```
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": "sts:AssumeRole",
    "Resource": "arn:aws:iam::222222222222:role/Role_B"
  }
}
 ```
 
 Role chaining: Through console always use the logger in user. Otherwise when u switch a role, if role a has permisssion to assume role b then that is sufficient.
 
 When you switch roles in the AWS Management Console, the console always uses your original credentials to authorize the switch. This applies whether you sign in as an IAM user, as a SAML-federated role, or as a web-identity federated role. For example, if you switch to RoleA, IAM uses your original user or federated role credentials to determine whether you are allowed to assume RoleA. If you then switch to RoleB while you are using RoleA, AWS still uses your original user or federated role credentials to authorize the switch, not the credentials for RoleA.
 
 
    
### Session polcies
 
Session policies are advanced policies that you pass as parameters when you programmatically create a temporary session for a role or federated user.
Used along with AssumeRole API.
When you pass session policies with AssumeRole API, the resulting session's permissions are the intersection of the IAM entity's identity-based policy and the session policies.  
A resource-based policy has a different effect on the evaluation of session policy permissions. The difference depends on whether the user or role's ARN or the session's ARN is listed as the principal in the resource-based policy. 
 
A resource-based policy can specify the ARN of the user or role as a principal. In that case, the permissions from the resource-based policy are added to the role or user's identity-based policy **before the session is created**. The session policy limits the total permissions granted by the resource-based policy and the identity-based policy. The resulting session's permissions are **the intersection of the session policies and the resource-based policies plus the intersection of the session policies and identity-based policies**.
 
A resource-based policy can specify the ARN of the session as a principal. In that case, the permissions from the resource-based policy are added **after the session is created**. The resource-based policy permissions are not limited by the session policy. **The resulting session has all the permissions of the resource-based policy plus the intersection of the identity-based policy and the session policy. **
 
 ### Policies and root user
 
**You cannot attach identity-based policies to the root user, and you cannot set the permissions boundary for the root user.** However, you can specify the root user as the principal in a resource-based policy or an ACL. A root user is still the member of an account. If that account is a member of an organization in AWS Organizations, the root user is affected by any SCPs for the account.
 
### Revoking temporary credentials
 
- Denying access to the creator of the temporary security credentials
- Denying access to temporary security credentials by name
- Denying access to temporary security credentials issued before a specific time
 
You cannot delete temporary credentials. You can Revoke permission of creator , the identity that was used when calling STS APIs to generate temporary credentials. Revoke by user, or role or by time. 
You can attach a deny all policy that applies only if the temporary credential was issued before a specific time (using aws:TokenIssueTime variable).

Revoking IAM role temporary security credentials: you can immediately revoke all permissions to the role's credentials issued before a certain point in time if you need to. All temporary credentials for that role issued before the specified time become invalid. This forces all users to reauthenticate and request new credentials.

You cannot revoke the session for a service-linked role.
 
To immediately deny all permissions to any current user of **role credentials**: choose the Revoke sessions tab. IAM immediately attaches a policy named AWSRevokeOlderSessions to the role. The policy denies all access to users who assumed the role before the moment you choose Revoke active sessions. Any user who assumes the role after you choose Revoke active sessions is not affected.
 
If you follow the steps above, all users with current sessions created by assuming the role are denied access to all AWS actions and resources. This can result in users losing unsaved work. When you revoke permissions for a role using the procedure above, AWS attaches a new inline policy to the role that denies all permissions to all actions. It includes a condition that applies the restrictions only if the user assumed the role before the point in time when you revoke the permissions. If the user assumes the role after you revoked the permissions, then the deny policy does not apply to that user.
 
 
 - Temporary security credentials are valid until they expire, and they cannot be revoked. 
 - To change or remove the permissions assigned to temporary security credentials, you can **change or remove the permissions** that are associated with the creator of the credentials. 
 - You can deny access to temporary security credentials without affecting the permissions of the IAM user or role that created the credentials. You do this by specifying the (ARN) of the temporary security credentials in the Principal element of a resource-based policy.
 - It is possible to deny access only to temporary security credentials that were created before a specific time and date. You do this by specifying a value for the aws:TokenIssueTime key in the Condition element of a policy. Attach policy to the following example to the IAM user that created the temporary security credentials. 
 
 ```
 {
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Deny",
    "Action": "*",
    "Resource": "*",
    "Condition": {"DateLessThan": {"aws:TokenIssueTime": "2014-05-07T23:47:00Z"}}
  }
}

Deleting access key

You can't recover an access key after you delete it. Any users or applications that are using the access key won't be able to programmatically access your account and resources after you delete the key. Be sure to check that the access key is no longer in use before you delete it. 


 ```
 
 Specifing aws account or root is same. They will give access to root and administrator user. They can grant permission to other IAM users and roles.

 IAM doesnt allow nesting of groups. You cannod add a group as child of another group.

 You cannot use groups in resource based policy.

 If u want to deny access to S3 for one group: Create a policy that denied access to S3 and add policy to the group.
 You cannot use groups in resource based policy.


 Lost password

 AWS account root user password : Choose Forgot your password?. \
 AWS account access keys : you can create new access keys  \
 IAM user password : ask your administrator to reset your password. \
 IAM user access keys : need new access keys. 


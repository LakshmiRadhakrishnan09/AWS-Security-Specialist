

* Symmetric Encryption: Same Key for encryption and decryption. AES 256.( 256 bits). Is fast.
* Asymmetric encryption or public-key encryption: Public key and private key. Encrypt with one key and decrypt with another key. RSA, ECC, DH. Computation expensive. 
    * Used primarly for securley exchanging symmetric key over internet: TLS/SSL over HTTPS. Used once in the handshake process.
    * Digital Signature, used in CloudTrail log integrity validation

### Envelop Encryption

Plain Text --- Encrypted using **Data Key**   --- Encrypted Text \
Data Key   --- Encrypted using **Master Key** --- Encrypted Data Key \
Envelop --- > Encrypted Text + Encrypted Data Key \
Master Key is stored in KMS Service.


Benefits: If you use data key only, then u can use same data key for all data. If you use master key, u can use different data key for each data. 
Compromise of one data key will not result in compromise of other data.


#### S3-Server side encryption
- KMS will have master key
- S3 asks KMS to generate data key
- KMS returns data key, encrypted data key
- Master key never leaves KMS
- S3 used data key for AES 256 encryption

Master key is identified by keyId, Key arun, alias, alias arn. **Alias** is used for rotating and it points to current master key. \
Encrypted data key has reference to master key ID. So even in case master key is rotated, it refers to old master key. \

Each object has different data key.

#### EBS Encryption

Optional feature u can enable when u create a volume

- EBS calls KMS service to get data key.
- The encrypted data key is stored in the volume.
- Use single data key for the volume. Enables high performance.
- When we attach volume to EC2 instance, the identity of user who is attaching volume is used to get data key from KMS.
- The EC2 host keep the data key in memory till host is stopped
- All data moving betwwen ec2 and volume is encrypted
- data at rest is encrypted

Unencrypted Volume --- Snapshot is Unencrypted --- Restored Volume is Unencrypted \
Encrypted Volume by key A---- Snapshot is Unencrypted by Key A--- Restored Volume is Unencrypted by Key A\

To change encryption: 
   - Unencrypted Volume --- Unencrypted SnapShot --- Enable Encryption while Restoring --- encrypted volume
   - Unencrypted Volume --- Unencrypted SnapShot --- Enable Encryption while Snapshot copy --- encrypted volume
   
To change encryption key: 
   - Encrypted Volume by Key A--- encrypted SnapShot by Key A --- Encrypt with Key B --- encrypted volume by key B
   - Encrypted Volume by Key A--- encrypted SnapShot by Key A --- Encrypt with key B while Snapshot copy --- encrypted volume by key B
   - Above process automatically decrypt with key A and encrypt with key B

Across Region:
   - KMS key is a regional resource
   - When u copy snapshot to a new region, use new  key in destination region
   - Snapshot automatically decrypt and encrypt using new key

EBS Encryption by default: Regional level setting. Any new EBS volume is automatically encypted using configured master key.Snapshot copies are automatically encrypted.

#### RDS Encryption

Optional feature

- Volumes, logs, snapshots, backups are encrypted
- Read replica is encrypted with same key in same region
- Read replica is encrypted with different key in case of cross region replication
- Encrypting by snapshot work similar to EBS

RDS also supports Transparent Data Encryption (TDE) for SQL Server (Enterprise Edition) and Oracle (with Advanced security option in Enterprise Edition).
. Transparent Data Encryption in Oracle is integrated with AWS CloudHSM.

You can encrypt communication between your application and the database using SSL/TLS. “Amazon RDS creates an SSL certificate and installs the certificate on the DB instance when the instance is provisioned”
You would need to download the public key and use it to encrypt connection to the database.

#### DynamoDB Encryption

- Encrypted at rest
- You can change encryption key of existing tables.

#### Key Rotation

AWS Managed Keys:  automatically rotated every year /
AWS Owned Keys: no visibility to these keys and rotation frequency varies /
Customer Managed Keys (CMK): 
   * KMS - Key generated by KMS. Optionally enable automatic-rotation - rotated every year. If you need to rotate key material at any other frequency (like monthly, quarterly, and so forth), you can rotate them manually.
   * External Key Origin : Import customer owned key generation material. **cannot be rotated automatically, and you need to rotate them manually**
   * CloudHSM: CloudHSM **cannot rotate the key material automatically, and you need to rotate them manually**

#### KMS API

KMS Encrypt, Decrypt, ReEncrypt are for **small data** like data keys, passwords, personel identifiers and other sensitive data.  

#### HMAC (Hash-Based Message Authentication Code) Keys

Normal hash algorithms are susceptible to brute-force attacks. Normal hash algoritm dont use a secret key.  HMAC improves by incorporating a secret key. 
They work like digital signatures but use the same key for both signing and verification.

·  The max message size is 4KB for GenerateMAC, VerifyMAC

· HMAC Keys do not support automatic key rotation or imported key material

· HMAC keys are currently not supported in CloudHSM (custom key store)

#### KMS Multi Key Region

Cross region replication different region: AWS will decrypt and re-encrypt with a different key for destination region. So, in case of server side encryption you were able to access the same data in different regions even though they were encrypted with different single-region keys. 

MultiRegion Key scenarios: 

* Some times application encrypt data before storing in database. Client Side Encryption. The keys used for this are stored in KMS. 
 - During Disaster Recovery, application may need to use data from different region. 
      Region1 --- Appl --- Key1(Region1)--- DataBase \
      Region2 --- Appl --- How to use key1? --- Backup DataBase \
Solution: Multi-Region Key

* Global applications that need to access data from multiple regions. 
   App --- Database(Region1) \
       --- Database(Region2) \
Solution:    Multi-Region Key

* Active-Active applications with client side encryption. For eg: DynamoDB Global Tables. \
  App --- Database(Region1) \
              |
              |
              |
           Auto Sync
              |
              |
              |
  App2 ---Database(Region2) 

* Distributed Signing :if you use certificate chaining with a single global trust store for a single root certification authority (CA), and regional CAs signed by the root CA, you don't need multi-region keys. However, if your system doesn't support intermediate CAs, you can use multi-region keys to bring consistency
      
you cannot convert your existing single region key to a multi-region key.
CloudHSM (custom key store) currently does not support multi-region keys; however, they do support backup and restore.


KMS Keys : If user has access to read bucket

- SSE-S3 : No protection as S3 automatically decrypt the message
- SSE-KMS : One layer of protection. User should have access to key
- SSE-C: Cannot read data without key
- Client Side: Can read data but cannot decrypt

SSE-S3: Key is generated and managed by AWS. Data is encrypted before saving and decrypted when u request it.

SSE-KMS: Customer Managed Keys(CMKs) stored in AWS KMS. There are two types of CMKs.

- Awazon managed CMK : Key generated by AWS. Stored in AWS account of customer

- Customer managed CMK: Key is genereted by customer. But stored in AWS account of customer.

SSE with Customer-Provided Keys (SSE-C): Key is generated by customer and stored by customer. A client has to send the encryption key along with the object to be uploaded in a request. S3 then encrypts the object using the provided key and the object is stored in S3. Note that the encryption key is deleted from the system.When the user wants to download or retrieve the object it has to supply the encryption key in the request. S3 first verifies that it is the correct encryption key, after the successful match it decrypts the object and returns it to the Client.




To monitor
- Logs
- Event Bus
- CloudWatch : Metrics Monitoring 

### CloudWatch : Monitoring

AWS Services automatically and continuously publish **metrics** to cloudwatch. You can publish custom metrics from ur application.
Default 5 minutes. Detailed monitoring every 1 minute. 

EC2 instance metrics -> CPU utilization, Network I/O, Memory(Using Agent), Disk(Using Agent), Instance Status check( Appln status), System status Check(Infrastructure Status) \
ELB metrics --> Request Count, Errors, Healthy host counts.

Create Alarms against metrics.

### CloudWatch Logs : Monitoring Logs

U can consolidate all logs generated by servers and ur application.

To send logs from an instance: 
- Install Cloud Watch **Log agent** in instance
- Configure Agent to use isntance IAM role
- Point agent to log files path
- Specify signature of log entries
- Provide Log Group destination in CloudWatch Log
- Agent automatically push the event as Log Event.
- Handle log rotation
- Each log event has timestamp and payload
- Log Stream is a sequence of log events from same source
- If u have 2 instances, there will be 2 log streams
- All log streams groups to a log group.

**One Log Group per application**. \
Assign retension setting to a Log Group. Assign Metric Filter to Log Stream. Metric Filter publish metric to Cloudwatch.


- Using SDK. Application directly writes to CloudWatch Logs service.

### CloudWatch Events 

Look for events and trigger action. Eg: Scheduled tasks like take snapshot of EBS.

Old Service . New service is EventBridege

### EventBridge

Any change on state is send as events to EventBridge. Subscribers services like EC2, Lambda can subscribe to these events.

Eg events: EC2 instance state changes. \
You can configure scheduled events. EBS snapshot \
ASG event when new instances added\removed. \
CloudTrail also publishes API actions as events. An event in CloudTrail is the record of an activity in an AWS account. \
Ur application can also publish events.

To log events : configure a log group and subscribe to event bridege. 

In a region, Go to EventBridge console. Select Event Buses. Default bus is used by aws and automatically created. Select Rules. Create Rule(On Event or Scheduled). Eg: EC2StateChangeRule. Select Service-Ec2. Select Events ( Eg: AWS API call with CloudTrail , EBS snapshot notification, Spot Instance Interruption warning, EC2 instance state change notification). Select event bus. Configure Target (multiple). Target can be CloudWatch Log Group or Lambda. Create Rule. (note: If u go to CloudWatch console , u can see rule here. In earlier versions events are created under cloud watch events)

### CloudTrail: Audit Trail

Captures all API calls in your account.

An event in CloudTrail is the record of an activity in an AWS account.

      - Who made the call with what credentials
      - TimeStamp
      - Requestor IP address, region
      - AWS service, action, resource
      - error messages
      - Final response

- Management Event
     - Changes to Security Group, Launching new instance, **Console log in**
     - KMS Management Events
       - Read Events. Eg. KMS Encrypt, decrypt , generate data key -> High Volume events
       - Write Events. Eg. Disable, delete -> Low Volume events
- Data Events
      - S3 Object Access
      - Lambda Function Invocation
      - Data events are not logged by default when you create a trail. 

Sign in events are always reported on N.Virgnia

CloudTrail Evenst are captured in Event Histiory, S3, CloudWatch Logs, CloudWatch Events, CloudTrail Insights.

##### CloudTrail Event History : 
  - Captures limited management events
  - 90 days
  - Region specific
  - Under Cloud Trail Service
            - Event History
            - All events are listed under a table
            - Can view details and event json in Console
 - By default available
 - Not very useful as we need to check events in different regions( Console Login in N.Virginia, S3 calls and VPC calls in specif regions)

##### Create Trail in S3 or CloudWatch Log Groups

S3:
  - Events across region to single bucket
  - u can enable log file integrity validation( Log file + digest file)

CloudWatch Log Groups
  - All regions
  - Log Insight Query Tool

Go to CloudTrail -- Go to ur primary Region -- Create Trail \
```
    By default available for all regions(after u create a trail) \
    Enable for all accounts in my organization( if u are using master account) \
    Create S3 bucket - in primary region \
    Enable encryption \
    Enable log file validation \
    Enable CloudWatch Logs. Create a new Log Group. Role for LogGroup delivery \
    Choose Log events. Pick Management Events or Data Events or Insight Events \
    Choose Managmenet Events : Read or Write or Exclude KMS events \
    Create Trail \
      Home region \
      Multi Region \
      S3 bucket \
      Cloud Watch Log Group \
      each region will have trail which is periodically upload to central group \
      If u go to another region, u can see the configured trail(listed) with home region set \
            If u go to S3, AWSLog/Account/CloudTrail/<region>/<year>/<month>/<day> \
              files are json compressed \
              Digest files \
            If u go to CloudWatch Service, Select Log Group \
              U can see events in Log Stream ( similar to kibana logs/events, json) \
 ```     
**CloudWatch Log Insights: For querying CloudTail events in CloudWatch Log Groups**

Go to CloudWatch Console. Select Insights. Select Log Group to query. Pick CloudTrail Log Group. You can see events as in kibana dashboard. 
It Automatically discovers the fields(different for cloudtrail and vpc log and Ec2 log). You can write query based on fields and run query.
Easily query events in LogGroup. Since Loggroup has consolidated logs from all regions it is easy. So compared to Event History this is better to query and get a consolidated view.
      
With Log group subscription you can publish events to other services.( eg: lambda, elastic search )  

**S3 Athena: For querying CloudTrail events in S3**

Configure Athena. Configure S3 for storing results. Create Table. From Event History u can create Athena Table. Parse json and present as a table. Perfect for adhoc analysis of S3 data.

##### CloudWatch Events(with EventBus)
  - Can have subscribers to process events
  - In single region
  - when to use this: when u want to take actions

##### CloudTrail Insights
      
  - ML to analyse
  - Detect anomalies
  

#### CloudTrail Configuration Best Practices

CloudTrail is Region Specific. To monitor activities in all regions cloudTail need to be set up in each region. Use "Enable Trail in all regions". Trail configuration is centally managed. CloudTrail send to S3 bucket to single log group.

Create S3 bucket and Log Group in seperate Account. 

Use s3-kms encryption

Manage life cycle and use Glacier for long term storage

Enable AWS Organization Trails. Multiple Accounts to a single Log Group

Most global services log events in N.Virginia

##### Service Logs

Global Service Logs: GA, CloudFront

VPC Flow Logs

ELB Logs

You can consolidate and analyse all these logs using CloudWatch.

Most of AWS service deliver logs to S3 or cloudWatch or eventbus(temporary storage)

Logging is not enabled by default.


How to detect and take action if root identity is used? Configure Rule in event bus for Console Sign In by Root and subscribe SNS topic. Or configure CloudWatch Metric for Log Group. \

Option 2 explained: Trail Home Region. CloudWatch Console. Log Group. Go to CloudTrail Log Group(u created). Go to Metric Filter Tab Group. Create Metric Filter. Apply filter on incoming log events . 
{ $.userIdentity.type == "Root" } . Set up Alarm . Set Notification.

Event Bus approach is near real time. Log group approach has some delivery delay( up to 15 minutes). Advantage is u can implement more complex alarms.

### Monitor failed login attempts

Linux OS log failed login attempts in /var/log/secure. To monitor these logs, configure cloudwatch agents. 

Install cloudwatch agent using System Manager. Store configurations in Paramaeter store. To install agent use Run Command. Run command need a document. It refers to a set of actions. AWS-ConfigureAWSPackage document. Select AmazonCloudWatch Agent and Choose Install. Login to EC2 instance using session manager. Start Wizard for configuration(by running command). Select configuration for cloudwatch( do you want to monitor host metrics?, high resolution?, any log files to monitor?). Store configuration in Parameter Store. 

To start agent. CloudWatchManage document. Specify parameter name. 


CloudWatch Agent can be used for publishing memory usage and disk usage.
